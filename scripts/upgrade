#!/bin/bash

#=================================================
# GENERIC START
#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source /usr/share/yunohost/helpers

#=================================================
# MANAGE SCRIPT FAILURE
#=================================================

# Exit if an error occurs during the execution of the script
ynh_abort_if_errors

#=================================================
# LOAD SETTINGS
#=================================================

app=$YNH_APP_INSTANCE_NAME
domain=$(ynh_app_setting_get mattermost domain)
is_public=$(ynh_app_setting_get mattermost is_public)

root_path="$(pwd)/.."
final_path=/var/www/mattermost
version=$(cat "$root_path/VERSION")
archive_filename="mattermost-$version.tar.gz"

#=================================================
# BACKUP BEFORE UPGRADE THEN ACTIVE TRAP
#=================================================

# Backup the current version of the app
ynh_backup_before_upgrade
ynh_clean_setup () {
  # Restore the backup if the upgrade fails
  ynh_restore_upgradebackup
  # Remove the temporary archive
  sudo rm -f "$archive_filename"
  # Restart the server
  sudo supervisorctl restart mattermost
}

# Exit if an error occurs during the execution of the script
ynh_abort_if_errors

#=================================================
# DOWNLOAD SOURCE
#=================================================

archive_url="https://releases.mattermost.com/${version}/mattermost-team-${version}-linux-amd64.tar.gz"
sudo wget --quiet --output-document "$archive_filename" "$archive_url"

#=================================================
# STOP SERVER
#=================================================

sudo supervisorctl stop mattermost

#=================================================
# BACKUP CONFIGURATION FILE
#=================================================

config_file="$final_path/config/config.json"
backup_config_file="/tmp/config.json"

sudo cp -f "$config_file" "$backup_config_file"

#=================================================
# COPY NEW CODE
#=================================================

sudo rm -rf "$final_path"
sudo mkdir -p "$final_path"
sudo tar -xvz --file "$archive_filename" --directory "$final_path" --strip-components 1
sudo rm -f "$archive_filename"

#=================================================
# RESTORE CONFIGURATION FILE
#=================================================

sudo cp -f "$backup_config_file" "$config_file"

#=================================================
# SPECIFIC UPGRADE STEPS
#=================================================

# Fix log FileLocation path (changed in Mattermost 3.8, makes Mattermost >= 4.2 crash)
# https://docs.mattermost.com/administration/changelog.html#release-v3-8-3
sudo sed -i "s|\"FileLocation\": \"/var/log/mattermost.log\"|\"FileLocation\": \"/var/log\"|g" "$config_file"

#=================================================
# RESTORE FILE PERMISSIONS
#=================================================

sudo chown -R www-data: "$final_path"

#=================================================
# RELOAD NGINX
#=================================================

sudo service nginx reload

#=================================================
# START SERVER
#=================================================

sudo supervisorctl start mattermost
