#!/bin/bash
set -u  # treat unset variables as an error

#=================================================
# GENERIC START
#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source /usr/share/yunohost/helpers

#=================================================
# LOAD SETTINGS
#=================================================

app=$YNH_APP_INSTANCE_NAME
domain=$(ynh_app_setting_get mattermost domain)
db_name="mattermost"
db_user="mmuser"
final_path="/var/www/$app"
data_path="/home/yunohost.app/$app"

#=================================================
# STANDARD REMOVE
#=================================================
# STOP AND REMOVE SERVICE
#=================================================

sudo supervisorctl stop "$app"
sudo rm -f "/etc/supervisor/conf.d/${app}.conf"

#=================================================
# REMOVE THE MYSQL DATABASE
#=================================================

# (DROP USER IF EXISTS is only available on MySQL >= 5.7, so we don't use it for now)
ynh_mysql_execute_as_root "DROP DATABASE IF EXISTS $db_name ; DROP USER $db_user@localhost ;"

#=================================================
# REMOVE APP MAIN DIR
#=================================================

sudo rm -rf "$final_path"
sudo rm -rf "$data_path"

#=================================================
# REMOVE NGINX CONFIGURATION
#=================================================

sudo rm -f "/etc/nginx/conf.d/${domain}.d/${app}.conf"

#=================================================
# REMOVE LOG FILE
#=================================================

sudo rm -f "/var/log/${app}.log"

#=================================================
# REMOVE DEDICATED USER
#=================================================

sudo userdel "$app"
